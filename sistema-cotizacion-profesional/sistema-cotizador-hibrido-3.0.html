<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaci√≥n Profesional 3.0 - Hospital del M√≥vil</title>
    
    <!-- Librer√≠as necesarias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #dc2626;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --background: #f0f4f8;
            --white: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,133.3C960,128,1056,96,1152,90.7C1248,85,1344,107,1392,117.3L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header mejorado */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 30px;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header h1 {
            font-size: 52px;
            font-weight: 800;
            margin-bottom: 12px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            letter-spacing: -1px;
        }

        .header .subtitle {
            font-size: 22px;
            opacity: 0.95;
            font-weight: 500;
        }

        .header .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 50px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3);
        }

        /* Configuraci√≥n API visible */
        .api-config {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px dashed #f59e0b;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .api-config h3 {
            color: #92400e;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-config input {
            width: 100%;
            padding: 14px;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: white;
            transition: all 0.3s ease;
        }

        .api-config input:focus {
            outline: none;
            border-color: #d97706;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
        }

        .api-config .help-text {
            margin-top: 10px;
            font-size: 13px;
            color: #78350f;
            line-height: 1.6;
        }

        /* Boxes principales */
        .box {
            background: white;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        .box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .box-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .box-title::before {
            content: '';
            width: 6px;
            height: 32px;
            background: linear-gradient(180deg, var(--primary), var(--purple));
            border-radius: 3px;
        }

        /* Formulario de b√∫squeda mejorado */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group select,
        .form-group input {
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Botones mejorados */
        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Estad√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 2px solid #bae6fd;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.2);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tabla de resultados */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
        }

        thead th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        thead th:first-child {
            border-top-left-radius: 12px;
        }

        thead th:last-child {
            border-top-right-radius: 12px;
        }

        tbody tr {
            background: white;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #f8fafc;
            transform: scale(1.01);
        }

        tbody td {
            padding: 16px 15px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .badge-amazon { background: #ff9900; color: white; }
        .badge-ebay { background: #e53238; color: white; }
        .badge-mercadolibre { background: #ffe600; color: #333; }
        .badge-aliexpress { background: #ff4747; color: white; }
        .badge-new { background: #10b981; color: white; }
        .badge-used { background: #f59e0b; color: white; }

        /* Filtros */
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Gr√°fica */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal para cotizaci√≥n */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            border-radius: 20px;
            padding: 40px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--border);
        }

        .modal-header h2 {
            font-size: 28px;
            color: var(--text-primary);
        }

        .close-modal {
            font-size: 32px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background: #fee2e2;
            color: var(--danger);
            transform: rotate(90deg);
        }

        /* Referencias seleccionadas */
        .selected-refs {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .ref-card {
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }

        .ref-card h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .ref-card .ref-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .ref-card .ref-details div {
            display: flex;
            flex-direction: column;
        }

        .ref-card .ref-details strong {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .remove-ref {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-ref:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        /* Tabs para variantes */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Formulario de cotizaci√≥n */
        .quote-form {
            display: grid;
            gap: 20px;
        }

        .quote-form .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Botones de acci√≥n */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 36px;
            }

            .header .subtitle {
                font-size: 16px;
            }

            .box {
                padding: 20px;
            }

            .box-title {
                font-size: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Notificaciones toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideInRight 0.4s ease, slideOutRight 0.4s ease 2.6s;
            min-width: 300px;
            border-left: 5px solid var(--primary);
        }

        .toast.success {
            border-left-color: var(--secondary);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Checkbox personalizado */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Precio destacado */
        .price-highlight {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 16px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè• Hospital del M√≥vil</h1>
            <div class="subtitle">Sistema Profesional de Cotizaci√≥n de Refacciones v3.0</div>
            <div class="version-badge">üíé VERSI√ìN COMPLETA CON COMUNICACI√ìN BIDIRECCIONAL</div>
        </div>

        <!-- Carga de Datos desde Google Sheets -->
        <div class="api-config" style="text-align: center;">
            <h3 style="justify-content: center;">üìä Cargar Datos desde Google Sheets</h3>
            <button
                onclick="cargarUltimaBusqueda()"
                style="padding: 15px 30px; font-size: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                üì• Cargar √öltima B√∫squeda
            </button>
            <div class="help-text">
                üí° <strong>Tip:</strong> Haz click para cargar autom√°ticamente los datos de tu √∫ltima b√∫squeda en Google Sheets.
                O usa la URL con par√°metro ?id=COT-XXX para cargar una b√∫squeda espec√≠fica.
            </div>
        </div>

        <!-- Formulario de b√∫squeda -->
        <div class="box">
            <div class="box-header">
                <h2 class="box-title">üîç B√∫squeda de Refacciones</h2>
            </div>

            <form id="searchForm" class="form-grid">
                <div class="form-group">
                    <label>Tipo de Dispositivo</label>
                    <select id="deviceType" required>
                        <option value="">Seleccionar...</option>
                        <option value="smartphone">üì± Smartphone</option>
                        <option value="tablet">üì± Tablet</option>
                        <option value="laptop">üíª Laptop</option>
                        <option value="smartwatch">‚åö Smartwatch</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Marca</label>
                    <select id="brand" required>
                        <option value="">Seleccionar...</option>
                        <option value="apple">üçé Apple</option>
                        <option value="samsung">üì± Samsung</option>
                        <option value="huawei">üì± Huawei</option>
                        <option value="xiaomi">üì± Xiaomi</option>
                        <option value="motorola">üì± Motorola</option>
                        <option value="lg">üì± LG</option>
                        <option value="oneplus">üì± OnePlus</option>
                        <option value="google">üì± Google Pixel</option>
                        <option value="oppo">üì± Oppo</option>
                        <option value="vivo">üì± Vivo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" id="model" placeholder="Ej: iPhone 13, Galaxy S21" required>
                </div>

                <div class="form-group">
                    <label>Tipo de Pieza</label>
                    <select id="partType" required>
                        <option value="">Seleccionar...</option>
                        <option value="pantalla">üñ•Ô∏è Pantalla/Display</option>
                        <option value="bateria">üîã Bater√≠a</option>
                        <option value="camara">üì∑ C√°mara</option>
                        <option value="placa">üîå Placa Madre</option>
                        <option value="flex">üîó Flex/Conector</option>
                        <option value="bocina">üîä Bocina/Auricular</option>
                        <option value="microfono">üé§ Micr√≥fono</option>
                        <option value="boton">‚è∫Ô∏è Bot√≥n Power/Volumen</option>
                        <option value="carcasa">üì¶ Carcasa/Tapa</option>
                        <option value="cristal">ü™ü Cristal Trasero</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Variante (Opcional)</label>
                    <input type="text" id="variant" placeholder="Ej: OLED, LCD, Original">
                </div>
            </form>

            <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="buscarRefacciones()">
                    üîç Buscar Refacciones
                </button>
                <button class="btn btn-success" onclick="buscarDispositivosCompletos()">
                    üì± Buscar Dispositivos Completos
                </button>
                <button class="btn btn-warning" onclick="limpiarFormulario()">
                    üóëÔ∏è Limpiar
                </button>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div id="statsSection" style="display: none;">
            <div class="box">
                <div class="box-header">
                    <h2 class="box-title">üìä Estad√≠sticas de B√∫squeda</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalResults">0</div>
                        <div class="stat-label">Total Resultados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgPrice">$0</div>
                        <div class="stat-label">Precio Promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="minPrice">$0</div>
                        <div class="stat-label">Precio M√≠nimo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxPrice">$0</div>
                        <div class="stat-label">Precio M√°ximo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="platforms">0</div>
                        <div class="stat-label">Plataformas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div id="filtersSection" style="display: none;">
            <div class="box">
                <div class="filters">
                    <div class="filter-group">
                        <label>Plataforma</label>
                        <select id="filterPlatform" onchange="aplicarFiltros()">
                            <option value="all">Todas</option>
                            <option value="amazon">Amazon</option>
                            <option value="ebay">eBay</option>
                            <option value="mercadolibre">Mercado Libre</option>
                            <option value="aliexpress">AliExpress</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Condici√≥n</label>
                        <select id="filterCondition" onchange="aplicarFiltros()">
                            <option value="all">Todas</option>
                            <option value="new">Nuevos</option>
                            <option value="used">Usados</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Precio M√°ximo</label>
                        <input type="number" id="filterMaxPrice" placeholder="$" onchange="aplicarFiltros()">
                    </div>

                    <div class="filter-group">
                        <label>Ordenar Por</label>
                        <select id="filterSort" onchange="aplicarFiltros()">
                            <option value="price-asc">Precio: Menor a Mayor</option>
                            <option value="price-desc">Precio: Mayor a Menor</option>
                            <option value="rating-desc">Mejor Valorados</option>
                            <option value="shipping-time">Env√≠o M√°s R√°pido</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de resultados -->
        <div id="resultsSection" style="display: none;">
            <div class="box">
                <div class="box-header">
                    <h2 class="box-title">üìã Resultados de B√∫squeda</h2>
                    <button class="btn btn-success" onclick="abrirModalCotizacion()">
                        ‚úÖ Crear Cotizaci√≥n con Seleccionados
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAll" onchange="seleccionarTodos()">
                                </th>
                                <th>Producto</th>
                                <th>Plataforma</th>
                                <th>Condici√≥n</th>
                                <th>Precio</th>
                                <th>Valoraci√≥n</th>
                                <th>Env√≠o</th>
                                <th>Tiempo</th>
                                <th>Enlace</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Resultados din√°micos -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üîç</div>
                    <h3>No se encontraron resultados</h3>
                    <p>Intenta ajustar los filtros o realiza una nueva b√∫squeda</p>
                </div>
            </div>
        </div>

        <!-- Gr√°fica de precios -->
        <div id="chartSection" style="display: none;">
            <div class="box">
                <div class="box-header">
                    <h2 class="box-title">üìà An√°lisis de Precios</h2>
                </div>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Comparaci√≥n con dispositivos completos -->
        <div id="comparisonSection" style="display: none;">
            <div class="box">
                <div class="box-header">
                    <h2 class="box-title">‚öñÔ∏è Comparaci√≥n: Refacci√≥n vs Dispositivo Completo</h2>
                </div>
                <div id="comparisonContent">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cotizaci√≥n -->
    <div id="quoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Crear Cotizaci√≥n Profesional</h2>
                <span class="close-modal" onclick="cerrarModalCotizacion()">&times;</span>
            </div>

            <!-- Referencias base seleccionadas -->
            <div id="selectedRefsSection">
                <h3 style="margin-bottom: 20px; color: var(--text-primary);">
                    üîñ Referencias Base Seleccionadas
                </h3>
                <div id="selectedRefsList" class="selected-refs">
                    <!-- Referencias din√°micas -->
                </div>
            </div>

            <!-- Tabs para m√∫ltiples variantes -->
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab(0)">Variante 1</button>
                <button class="tab" onclick="cambiarTab(1)">Variante 2</button>
                <button class="tab" onclick="cambiarTab(2)">Variante 3</button>
                <button class="tab" onclick="cambiarTab(3)">Variante 4</button>
            </div>

            <!-- Contenido de tabs -->
            <div id="tabContent0" class="tab-content active">
                <form class="quote-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de Cliente *</label>
                            <input type="text" id="clientName1" required placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono *</label>
                            <input type="tel" id="clientPhone1" required placeholder="10 d√≠gitos">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail1" placeholder="correo@ejemplo.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Variante *</label>
                            <select id="variantType1" required>
                                <option value="premium">üåü Premium - Original OEM</option>
                                <option value="high">‚≠ê Alta Calidad - Compatible AAA</option>
                                <option value="standard">‚úÖ Est√°ndar - Compatible A</option>
                                <option value="economic">üí∞ Econ√≥mica - Compatible B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio de Venta *</label>
                            <input type="number" id="salePrice1" required placeholder="$0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tiempo de Entrega *</label>
                            <input type="text" id="deliveryTime1" required placeholder="Ej: 24-48 horas">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Garant√≠a</label>
                        <input type="text" id="warranty1" placeholder="Ej: 90 d√≠as contra defectos de f√°brica">
                    </div>

                    <div class="form-group">
                        <label>Notas Adicionales</label>
                        <textarea id="notes1" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: inherit; resize: vertical;" placeholder="Informaci√≥n adicional para el cliente..."></textarea>
                    </div>
                </form>
            </div>

            <div id="tabContent1" class="tab-content">
                <form class="quote-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de Cliente *</label>
                            <input type="text" id="clientName2" placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono *</label>
                            <input type="tel" id="clientPhone2" placeholder="10 d√≠gitos">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail2" placeholder="correo@ejemplo.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Variante *</label>
                            <select id="variantType2">
                                <option value="premium">üåü Premium - Original OEM</option>
                                <option value="high">‚≠ê Alta Calidad - Compatible AAA</option>
                                <option value="standard">‚úÖ Est√°ndar - Compatible A</option>
                                <option value="economic">üí∞ Econ√≥mica - Compatible B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio de Venta *</label>
                            <input type="number" id="salePrice2" placeholder="$0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tiempo de Entrega *</label>
                            <input type="text" id="deliveryTime2" placeholder="Ej: 24-48 horas">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Garant√≠a</label>
                        <input type="text" id="warranty2" placeholder="Ej: 90 d√≠as contra defectos de f√°brica">
                    </div>

                    <div class="form-group">
                        <label>Notas Adicionales</label>
                        <textarea id="notes2" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: inherit; resize: vertical;" placeholder="Informaci√≥n adicional para el cliente..."></textarea>
                    </div>
                </form>
            </div>

            <div id="tabContent2" class="tab-content">
                <form class="quote-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de Cliente *</label>
                            <input type="text" id="clientName3" placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono *</label>
                            <input type="tel" id="clientPhone3" placeholder="10 d√≠gitos">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail3" placeholder="correo@ejemplo.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Variante *</label>
                            <select id="variantType3">
                                <option value="premium">üåü Premium - Original OEM</option>
                                <option value="high">‚≠ê Alta Calidad - Compatible AAA</option>
                                <option value="standard">‚úÖ Est√°ndar - Compatible A</option>
                                <option value="economic">üí∞ Econ√≥mica - Compatible B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio de Venta *</label>
                            <input type="number" id="salePrice3" placeholder="$0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tiempo de Entrega *</label>
                            <input type="text" id="deliveryTime3" placeholder="Ej: 24-48 horas">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Garant√≠a</label>
                        <input type="text" id="warranty3" placeholder="Ej: 90 d√≠as contra defectos de f√°brica">
                    </div>

                    <div class="form-group">
                        <label>Notas Adicionales</label>
                        <textarea id="notes3" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: inherit; resize: vertical;" placeholder="Informaci√≥n adicional para el cliente..."></textarea>
                    </div>
                </form>
            </div>

            <div id="tabContent3" class="tab-content">
                <form class="quote-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de Cliente *</label>
                            <input type="text" id="clientName4" placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono *</label>
                            <input type="tel" id="clientPhone4" placeholder="10 d√≠gitos">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail4" placeholder="correo@ejemplo.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Variante *</label>
                            <select id="variantType4">
                                <option value="premium">üåü Premium - Original OEM</option>
                                <option value="high">‚≠ê Alta Calidad - Compatible AAA</option>
                                <option value="standard">‚úÖ Est√°ndar - Compatible A</option>
                                <option value="economic">üí∞ Econ√≥mica - Compatible B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio de Venta *</label>
                            <input type="number" id="salePrice4" placeholder="$0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tiempo de Entrega *</label>
                            <input type="text" id="deliveryTime4" placeholder="Ej: 24-48 horas">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Garant√≠a</label>
                        <input type="text" id="warranty4" placeholder="Ej: 90 d√≠as contra defectos de f√°brica">
                    </div>

                    <div class="form-group">
                        <label>Notas Adicionales</label>
                        <textarea id="notes4" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: inherit; resize: vertical;" placeholder="Informaci√≥n adicional para el cliente..."></textarea>
                    </div>
                </form>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="guardarCotizacion()">
                    üíæ Guardar en Google Sheets
                </button>
                <button class="btn btn-success" onclick="exportarCotizacionHTML()">
                    üìÑ Exportar HTML
                </button>
                <button class="btn btn-warning" onclick="exportarCotizacionPDF()">
                    Exportar PDF
                </button>
                <button class="btn" style="background: #8b5cf6; color: white;" onclick="exportarCotizacionJPG()">
                    Exportar JPG
                </button>
                <button class="btn btn-danger" onclick="cerrarModalCotizacion()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ============================================
        // CONFIGURACI√ìN WEB APP
        // ============================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyGgAU08S92arJd_ysoT3FfrGUpc7eScCXhLeo6HYLMAGkTcqSJhQqj3iaKbMfF415cHA/exec';

        // CONFIGURACION DE CONTACTO - Actualizar con datos reales
        const CONTACTO = {
            whatsapp: '5512345678',        // Numero de WhatsApp (sin +, sin espacios)
            email: 'contacto@hospitaldelmovil.com',
            negocio: 'Hospital del Movil',
            eslogan: 'Especialistas en Reparacion de Dispositivos Moviles'
        };

        // VARIABLES GLOBALES
        // ============================================
        let todosLosResultados = [];
        let resultadosFiltrados = [];
        let resultadosSeleccionados = [];
        let dispositivosCompletos = [];
        let chartInstance = null;
        let tabActual = 0;

        // ============================================
        // FUNCIONES DE INICIALIZACI√ìN
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            cargarAPIUrlDesdeStorage();
            cargarParametrosURL();
            console.log('‚úÖ Sistema de Cotizaci√≥n 3.0 Inicializado');
        });

        function cargarAPIUrlDesdeStorage() {
            // URL de API se usa desde WEB_APP_URL (constante)
        }

        function cargarParametrosURL() {
            const params = new URLSearchParams(window.location.search);

            // Si hay par√°metro 'id', cargar datos desde Web App
            if (params.get('id')) {
                setTimeout(() => cargarDesdeWebApp(params.get('id')), 500);
                return;
            }

            if (params.get('dispositivo')) {
                document.getElementById('deviceType').value = params.get('dispositivo');
            }
            if (params.get('marca')) {
                document.getElementById('brand').value = params.get('marca');
            }
            if (params.get('modelo')) {
                document.getElementById('model').value = params.get('modelo');
            }
            if (params.get('pieza')) {
                document.getElementById('partType').value = params.get('pieza');
            }
            if (params.get('variante')) {
                document.getElementById('variant').value = params.get('variante');
            }

            // Si hay par√°metros, buscar autom√°ticamente
            if (params.get('modelo')) {
                setTimeout(() => buscarRefacciones(), 500);
            }
        }

        // ============================================
        // CARGAR DATOS DESDE WEB APP
        // ============================================
        async function cargarDesdeWebApp(idBusqueda) {
            console.log('üì• Cargando datos desde Web App:', idBusqueda);
            mostrarSpinner();

            try {
                const url = `${WEB_APP_URL}?action=getHallazgos&id=${idBusqueda}`;
                console.log('üì° URL:', url);

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('üì¶ Datos recibidos:', data);

                if (!data.success) {
                    throw new Error(data.error || 'Error desconocido');
                }

                // Procesar datos
                todosLosResultados = data.piezas || [];
                dispositivosCompletos = {
                    nuevos: data.equipos_nuevos || [],
                    usados: data.equipos_usados || []
                };

                if (todosLosResultados.length === 0) {
                    mostrarNotificacion('‚ö†Ô∏è No se encontraron datos para este ID', 'warning');
                    ocultarSpinner();
                    return;
                }

                // Actualizar UI
                resultadosFiltrados = [...todosLosResultados];
                actualizarTablaResultados();
                generarGraficas();
                calcularIndicadores();
                mostrarResultados();
                ocultarSpinner();

                mostrarNotificacion(`‚úÖ Cargados ${todosLosResultados.length} hallazgos para ${idBusqueda}`, 'success');

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarNotificacion(`‚ùå Error al cargar datos: ${error.message}`, 'error');
                ocultarSpinner();
            }
        }

        async function cargarUltimaBusqueda() {
            console.log('üì• Cargando √∫ltima b√∫squeda...');
            mostrarSpinner();

            try {
                const url = `${WEB_APP_URL}?action=getUltimaBusqueda`;
                console.log('üì° URL:', url);

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('üì¶ Datos recibidos:', data);

                if (!data.success) {
                    throw new Error(data.error || 'Error desconocido');
                }

                const busqueda = data.busqueda;
                const hallazgos = data.hallazgos;

                // Procesar datos
                todosLosResultados = hallazgos.piezas || [];
                dispositivosCompletos = {
                    nuevos: hallazgos.equipos_nuevos || [],
                    usados: hallazgos.equipos_usados || []
                };

                if (todosLosResultados.length === 0) {
                    mostrarNotificacion('‚ö†Ô∏è No hay b√∫squedas disponibles', 'warning');
                    ocultarSpinner();
                    return;
                }

                // Actualizar UI
                resultadosFiltrados = [...todosLosResultados];
                actualizarTablaResultados();
                generarGraficas();
                calcularIndicadores();
                mostrarResultados();
                ocultarSpinner();

                mostrarNotificacion(`‚úÖ Cargada b√∫squeda: ${busqueda.id} - ${busqueda.pieza} para ${busqueda.marca} ${busqueda.modelo}`, 'success');

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarNotificacion(`Error al cargar ultima busqueda: ${error.message}`, 'error');
                ocultarSpinner();
            }
        }

        // ============================================
        // FUNCIONES DE B√öSQUEDA
        // ============================================
        async function buscarRefacciones() {
    const deviceType = document.getElementById('deviceType').value;
    const brand = document.getElementById('brand').value;
    const model = document.getElementById('model').value;
    const partType = document.getElementById('partType').value;
    const variant = document.getElementById('variant').value;

    if (!deviceType || !brand || !model || !partType) {
        mostrarNotificacion('‚ö†Ô∏è Por favor completa todos los campos obligatorios', 'warning');
        return;
    }

    mostrarSpinner();

    try {
        // Construir query de b√∫squeda
        const queryParts = [brand, model, partType];
        if (variant) queryParts.push(variant);
        const query = queryParts.join(' ');

        console.log('üîç Buscando:', query);

        // LLAMADA DIRECTA A MERCADOLIBRE (sin Apps Script)
        const url = `https://api.mercadolibre.com/sites/MLM/search?q=${encodeURIComponent(query)}&limit=20`;
        console.log('üì° URL:', url);

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        console.log('üì¶ Respuesta:', data);

        if (data.results && data.results.length > 0) {
            // Transformar datos de MercadoLibre al formato de tu app
            todosLosResultados = data.results.map(item => {
                const shippingCost = item.shipping?.free_shipping ? 0 : 150;
                const deliveryDays = item.shipping?.free_shipping ? 3 : 5;
                
                // Rating del vendedor
                let rating = 4.0;
                let reputation = 'Normal';
                if (item.seller?.seller_reputation) {
                    const rep = item.seller.seller_reputation;
                    if (rep.power_seller_status === 'platinum') reputation = 'Platino ‚≠ê‚≠ê‚≠ê';
                    else if (rep.power_seller_status === 'gold') reputation = 'Oro ‚≠ê‚≠ê';
                    else if (rep.power_seller_status === 'silver') reputation = 'Plata ‚≠ê';
                    
                    if (rep.transactions?.ratings?.positive) {
                        rating = (rep.transactions.ratings.positive / 100) * 5;
                    }
                }

                return {
                    id: item.id,
                    producto: item.title,
                    plataforma: 'mercadolibre',
                    condicion: item.condition === 'new' ? 'new' : 'used',
                    precio: parseFloat(item.price) || 0,
                    valoracion: rating.toFixed(1),
                    envio: item.shipping?.free_shipping ? 'Gratis' : `$${shippingCost}`,
                    tiempoEnvio: `${deliveryDays} d√≠as`,
                    url: item.permalink,
                    imagen: item.thumbnail || 'https://via.placeholder.com/100x100.png?text=Producto',
                    vendedor: item.seller?.nickname || 'Vendedor',
                    stock: item.available_quantity || 1
                };
            });
            
            resultadosFiltrados = [...todosLosResultados];
            
            mostrarResultados();
            mostrarEstadisticas();
            mostrarGrafica();

            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('filtersSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';

            mostrarNotificacion(`‚úÖ ${todosLosResultados.length} productos encontrados en MercadoLibre`, 'success');
            
        } else {
            mostrarNotificacion('‚ö†Ô∏è No se encontraron productos', 'warning');
            
            // Mostrar datos de ejemplo como fallback
            todosLosResultados = generarResultadosEjemplo(brand, model, partType, variant);
            resultadosFiltrados = [...todosLosResultados];
            
            mostrarResultados();
            mostrarEstadisticas();
            mostrarGrafica();

            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('filtersSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
        }

    } catch (error) {
        console.error('‚ùå Error:', error);
        mostrarNotificacion(`‚ùå Error: ${error.message}`, 'error');
        
        // Fallback a datos de ejemplo
        todosLosResultados = generarResultadosEjemplo(brand, model, partType, variant);
        resultadosFiltrados = [...todosLosResultados];
        
        mostrarResultados();
        mostrarEstadisticas();
        mostrarGrafica();

        document.getElementById('statsSection').style.display = 'block';
        document.getElementById('filtersSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('chartSection').style.display = 'block';
    } finally {
        ocultarSpinner();
    }
}

        async function buscarDispositivosCompletos() {
            const brand = document.getElementById('brand').value;
            const model = document.getElementById('model').value;

            if (!brand || !model) {
                mostrarNotificacion('‚ö†Ô∏è Selecciona marca y modelo primero', 'warning');
                return;
            }

            mostrarSpinner();

            setTimeout(() => {
                dispositivosCompletos = generarDispositivosEjemplo(brand, model);
                mostrarComparacion();
                ocultarSpinner();

                document.getElementById('comparisonSection').style.display = 'block';
                mostrarNotificacion('‚úÖ Comparaci√≥n lista', 'success');
            }, 1000);
        }

        // ============================================
        // GENERACI√ìN DE DATOS DE EJEMPLO
        // ============================================
        function generarResultadosEjemplo(brand, model, partType, variant) {
            const plataformas = ['amazon', 'ebay', 'mercadolibre', 'aliexpress'];
            const condiciones = ['new', 'used'];
            const resultados = [];

            const partTypeNames = {
                'pantalla': 'Pantalla',
                'bateria': 'Bater√≠a',
                'camara': 'C√°mara',
                'placa': 'Placa Madre',
                'flex': 'Flex',
                'bocina': 'Bocina',
                'microfono': 'Micr√≥fono',
                'boton': 'Bot√≥n',
                'carcasa': 'Carcasa',
                'cristal': 'Cristal'
            };

            const preciosBase = {
                'pantalla': { min: 800, max: 3500 },
                'bateria': { min: 200, max: 800 },
                'camara': { min: 400, max: 1500 },
                'placa': { min: 1500, max: 5000 },
                'flex': { min: 150, max: 600 },
                'bocina': { min: 100, max: 400 },
                'microfono': { min: 150, max: 500 },
                'boton': { min: 100, max: 350 },
                'carcasa': { min: 300, max: 1200 },
                'cristal': { min: 250, max: 900 }
            };

            for (let i = 0; i < 20; i++) {
                const plataforma = plataformas[Math.floor(Math.random() * plataformas.length)];
                const condicion = Math.random() > 0.3 ? 'new' : 'used';
                const rango = preciosBase[partType] || { min: 200, max: 2000 };
                
                let precio = Math.random() * (rango.max - rango.min) + rango.min;
                if (condicion === 'used') precio *= 0.7;

                const variantText = variant ? ` ${variant}` : '';
                const producto = `${partTypeNames[partType]}${variantText} para ${brand.toUpperCase()} ${model}`;

                resultados.push({
                    id: i + 1,
                    producto: producto,
                    plataforma: plataforma,
                    condicion: condicion,
                    precio: parseFloat(precio.toFixed(2)),
                    valoracion: (Math.random() * 2 + 3).toFixed(1),
                    envio: Math.random() > 0.5 ? 'Gratis' : `$${Math.floor(Math.random() * 200 + 50)}`,
                    tiempoEnvio: `${Math.floor(Math.random() * 20 + 3)}-${Math.floor(Math.random() * 10 + 25)} d√≠as`,
                    url: `https://${plataforma}.com/producto-ejemplo-${i}`,
                    imagen: `https://via.placeholder.com/100x100.png?text=${partType}`,
                    vendedor: `Vendedor ${Math.floor(Math.random() * 1000)}`,
                    stock: Math.floor(Math.random() * 50 + 1)
                });
            }

            return resultados;
        }

        function generarDispositivosEjemplo(brand, model) {
            const dispositivos = [];
            const condiciones = ['new', 'used-excellent', 'used-good', 'used-fair'];

            const precios = {
                'new': { min: 8000, max: 25000 },
                'used-excellent': { min: 6000, max: 18000 },
                'used-good': { min: 4000, max: 12000 },
                'used-fair': { min: 2500, max: 8000 }
            };

            condiciones.forEach((condicion, index) => {
                const rango = precios[condicion];
                const precio = Math.random() * (rango.max - rango.min) + rango.min;

                let condicionTexto = {
                    'new': 'Nuevo',
                    'used-excellent': 'Usado - Excelente',
                    'used-good': 'Usado - Bueno',
                    'used-fair': 'Usado - Aceptable'
                };

                dispositivos.push({
                    condicion: condicionTexto[condicion],
                    precio: parseFloat(precio.toFixed(2)),
                    descripcion: `${brand.toUpperCase()} ${model} ${condicionTexto[condicion]}`,
                    almacenamiento: ['64GB', '128GB', '256GB'][Math.floor(Math.random() * 3)],
                    garantia: condicion === 'new' ? '12 meses' : '30 d√≠as'
                });
            });

            return dispositivos;
        }

        // ============================================
        // FUNCIONES DE VISUALIZACI√ìN
        // ============================================

        // Aliases para compatibilidad con cargarDesdeWebApp/cargarUltimaBusqueda
        function actualizarTablaResultados() { mostrarResultados(); }
        function generarGraficas() { mostrarGrafica(); mostrarComparacion(); }
        function calcularIndicadores() { mostrarEstadisticas(); }

        function mostrarResultados() {
            const tbody = document.getElementById('resultsTableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (resultadosFiltrados.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            resultadosFiltrados.forEach(item => {
                const row = document.createElement('tr');
                
                const badgeClass = `badge-${item.plataforma}`;
                const conditionBadge = item.condicion === 'new' ? 'badge-new' : 'badge-used';
                const conditionText = item.condicion === 'new' ? 'Nuevo' : 'Usado';

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="result-checkbox" data-id="${item.id}" onchange="actualizarSeleccion()">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${item.imagen}" alt="${item.producto}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                            <div>
                                <strong>${item.producto}</strong>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    ${item.vendedor} ‚Ä¢ Stock: ${item.stock}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge ${badgeClass}">${item.plataforma.toUpperCase()}</span></td>
                    <td><span class="badge ${conditionBadge}">${conditionText}</span></td>
                    <td><span class="price-highlight">$${item.precio.toFixed(2)}</span></td>
                    <td>‚≠ê ${item.valoracion}</td>
                    <td>${item.envio}</td>
                    <td>${item.tiempoEnvio}</td>
                    <td><a href="${item.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">Ver üîó</a></td>
                `;

                tbody.appendChild(row);
            });
        }

        function mostrarEstadisticas() {
            const precios = resultadosFiltrados.map(r => r.precio);
            const plataformas = new Set(resultadosFiltrados.map(r => r.plataforma));

            document.getElementById('totalResults').textContent = resultadosFiltrados.length;
            document.getElementById('avgPrice').textContent = `$${(precios.reduce((a, b) => a + b, 0) / precios.length).toFixed(2)}`;
            document.getElementById('minPrice').textContent = `$${Math.min(...precios).toFixed(2)}`;
            document.getElementById('maxPrice').textContent = `$${Math.max(...precios).toFixed(2)}`;
            document.getElementById('platforms').textContent = plataformas.size;
        }

        function mostrarGrafica() {
            const ctx = document.getElementById('priceChart').getContext('2d');

            // Destruir gr√°fica anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Agrupar por plataforma
            const datosPorPlataforma = {};
            resultadosFiltrados.forEach(item => {
                if (!datosPorPlataforma[item.plataforma]) {
                    datosPorPlataforma[item.plataforma] = [];
                }
                datosPorPlataforma[item.plataforma].push(item.precio);
            });

            const labels = Object.keys(datosPorPlataforma);
            const promedios = labels.map(plat => {
                const precios = datosPorPlataforma[plat];
                return (precios.reduce((a, b) => a + b, 0) / precios.length).toFixed(2);
            });

            const colores = {
                'amazon': '#ff9900',
                'ebay': '#e53238',
                'mercadolibre': '#ffe600',
                'aliexpress': '#ff4747'
            };

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => l.toUpperCase()),
                    datasets: [{
                        label: 'Precio Promedio',
                        data: promedios,
                        backgroundColor: labels.map(l => colores[l] || '#2563eb'),
                        borderColor: labels.map(l => colores[l] || '#1d4ed8'),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Precio Promedio por Plataforma',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function mostrarComparacion() {
            const container = document.getElementById('comparisonContent');
            
            if (dispositivosCompletos.length === 0) {
                container.innerHTML = '<p>No hay datos de comparaci√≥n disponibles</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';

            dispositivosCompletos.forEach(dispositivo => {
                html += `
                    <div class="stat-card">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">${dispositivo.condicion}</h4>
                        <div class="stat-value">$${dispositivo.precio.toFixed(2)}</div>
                        <div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary); text-align: left;">
                            <p><strong>Almacenamiento:</strong> ${dispositivo.almacenamiento}</p>
                            <p><strong>Garant√≠a:</strong> ${dispositivo.garantia}</p>
                            <p><strong>Descripci√≥n:</strong> ${dispositivo.descripcion}</p>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Agregar an√°lisis
            if (resultadosFiltrados.length > 0) {
                const precioPromedioRefaccion = resultadosFiltrados.reduce((acc, r) => acc + r.precio, 0) / resultadosFiltrados.length;
                const dispositivoMasBarato = Math.min(...dispositivosCompletos.map(d => d.precio));
                const diferencia = dispositivoMasBarato - precioPromedioRefaccion;
                const porcentaje = ((precioPromedioRefaccion / dispositivoMasBarato) * 100).toFixed(1);

                html += `
                    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 16px; border: 2px solid #10b981;">
                        <h3 style="color: #065f46; margin-bottom: 15px;">üìä An√°lisis de Rentabilidad</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <strong style="color: #047857;">Precio Promedio Refacci√≥n:</strong><br>
                                <span style="font-size: 24px; color: var(--primary);">$${precioPromedioRefaccion.toFixed(2)}</span>
                            </div>
                            <div>
                                <strong style="color: #047857;">Dispositivo Completo M√°s Barato:</strong><br>
                                <span style="font-size: 24px; color: var(--primary);">$${dispositivoMasBarato.toFixed(2)}</span>
                            </div>
                            <div>
                                <strong style="color: #047857;">Diferencia:</strong><br>
                                <span style="font-size: 24px; color: ${diferencia > 0 ? '#dc2626' : '#10b981'};">$${Math.abs(diferencia).toFixed(2)}</span>
                            </div>
                            <div>
                                <strong style="color: #047857;">La refacci√≥n representa:</strong><br>
                                <span style="font-size: 24px; color: var(--primary);">${porcentaje}%</span>
                            </div>
                        </div>
                        <p style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; color: #065f46; line-height: 1.6;">
                            ${diferencia > 0 
                                ? `‚ö†Ô∏è La refacci√≥n cuesta m√°s que comprar un dispositivo usado. Se recomienda evaluar la opci√≥n de dispositivo completo.`
                                : `‚úÖ La reparaci√≥n es ${Math.abs(diferencia).toFixed(0)} pesos m√°s econ√≥mica que comprar un dispositivo usado.`
                            }
                        </p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ============================================
        // FUNCIONES DE FILTROS
        // ============================================
        function aplicarFiltros() {
            const plataforma = document.getElementById('filterPlatform').value;
            const condicion = document.getElementById('filterCondition').value;
            const maxPrice = parseFloat(document.getElementById('filterMaxPrice').value) || Infinity;
            const sortBy = document.getElementById('filterSort').value;

            resultadosFiltrados = todosLosResultados.filter(item => {
                if (plataforma !== 'all' && item.plataforma !== plataforma) return false;
                if (condicion !== 'all' && item.condicion !== condicion) return false;
                if (item.precio > maxPrice) return false;
                return true;
            });

            // Ordenar
            switch (sortBy) {
                case 'price-asc':
                    resultadosFiltrados.sort((a, b) => a.precio - b.precio);
                    break;
                case 'price-desc':
                    resultadosFiltrados.sort((a, b) => b.precio - a.precio);
                    break;
                case 'rating-desc':
                    resultadosFiltrados.sort((a, b) => parseFloat(b.valoracion) - parseFloat(a.valoracion));
                    break;
                case 'shipping-time':
                    resultadosFiltrados.sort((a, b) => {
                        const timeA = parseInt(a.tiempoEnvio.split('-')[0]);
                        const timeB = parseInt(b.tiempoEnvio.split('-')[0]);
                        return timeA - timeB;
                    });
                    break;
            }

            mostrarResultados();
            mostrarEstadisticas();
            mostrarGrafica();
        }

        // ============================================
        // FUNCIONES DE SELECCI√ìN
        // ============================================
        function seleccionarTodos() {
            const checkboxes = document.querySelectorAll('.result-checkbox');
            const selectAll = document.getElementById('selectAll');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });

            actualizarSeleccion();
        }

        function actualizarSeleccion() {
            const checkboxes = document.querySelectorAll('.result-checkbox:checked');
            resultadosSeleccionados = [];

            checkboxes.forEach(cb => {
                const id = parseInt(cb.dataset.id);
                const item = resultadosFiltrados.find(r => r.id === id);
                if (item) resultadosSeleccionados.push(item);
            });

            console.log('Seleccionados:', resultadosSeleccionados.length);
        }

        // ============================================
        // MODAL DE COTIZACI√ìN
        // ============================================
        function abrirModalCotizacion() {
            if (resultadosSeleccionados.length === 0) {
                mostrarNotificacion('‚ö†Ô∏è Selecciona al menos un producto para crear la cotizaci√≥n', 'warning');
                return;
            }

            mostrarReferenciasSeleccionadas();
            document.getElementById('quoteModal').style.display = 'block';
        }

        function cerrarModalCotizacion() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        function mostrarReferenciasSeleccionadas() {
            const container = document.getElementById('selectedRefsList');
            container.innerHTML = '';

            resultadosSeleccionados.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'ref-card';
                div.innerHTML = `
                    <h4>Referencia ${index + 1}</h4>
                    <div class="ref-details">
                        <div>
                            <strong>Producto</strong>
                            <span>${item.producto}</span>
                        </div>
                        <div>
                            <strong>Plataforma</strong>
                            <span>${item.plataforma.toUpperCase()}</span>
                        </div>
                        <div>
                            <strong>Precio</strong>
                            <span>$${item.precio.toFixed(2)}</span>
                        </div>
                        <div>
                            <strong>Condici√≥n</strong>
                            <span>${item.condicion === 'new' ? 'Nuevo' : 'Usado'}</span>
                        </div>
                    </div>
                    <button class="remove-ref" onclick="eliminarReferencia(${index})">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        function eliminarReferencia(index) {
            resultadosSeleccionados.splice(index, 1);
            mostrarReferenciasSeleccionadas();
            
            if (resultadosSeleccionados.length === 0) {
                cerrarModalCotizacion();
                mostrarNotificacion('‚ÑπÔ∏è No hay referencias seleccionadas', 'warning');
            }
        }

        // ============================================
        // TABS
        // ============================================
        function cambiarTab(index) {
            // Actualizar tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Actualizar contenido
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach((content, i) => {
                if (i === index) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            tabActual = index;
        }

        // ============================================
        // GUARDAR Y EXPORTAR
        // ============================================
        async function guardarCotizacion() {
            // Recopilar datos de todas las variantes activas
            const cotizaciones = [];

            for (let i = 1; i <= 4; i++) {
                const clientName = document.getElementById(`clientName${i}`).value;

                if (clientName) { // Solo si tiene nombre de cliente
                    cotizaciones.push({
                        folio: generarFolio(),
                        fecha: new Date().toISOString(),
                        clienteNombre: clientName,
                        clienteTelefono: document.getElementById(`clientPhone${i}`).value,
                        clienteEmail: document.getElementById(`clientEmail${i}`).value,
                        dispositivo: document.getElementById('deviceType').value,
                        marca: document.getElementById('brand').value,
                        modelo: document.getElementById('model').value,
                        pieza: document.getElementById('partType').value,
                        variante: document.getElementById('variant').value,
                        tipoVariante: document.getElementById(`variantType${i}`).value,
                        precioVenta: parseFloat(document.getElementById(`salePrice${i}`).value) || 0,
                        tiempoEntrega: document.getElementById(`deliveryTime${i}`).value,
                        garantia: document.getElementById(`warranty${i}`).value,
                        notas: document.getElementById(`notes${i}`).value,
                        referenciasBase: JSON.stringify(resultadosSeleccionados),
                        estado: 'Pendiente'
                    });
                }
            }

            if (cotizaciones.length === 0) {
                mostrarNotificacion('Completa al menos una variante con nombre de cliente', 'warning');
                return;
            }

            try {
                mostrarSpinner();

                for (const cotizacion of cotizaciones) {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({
                            action: 'saveCotizacion',
                            data: cotizacion
                        })
                    });
                }

                ocultarSpinner();
                mostrarNotificacion(`${cotizaciones.length} cotizacion(es) guardada(s) exitosamente`, 'success');
                cerrarModalCotizacion();

            } catch (error) {
                console.error('Error:', error);
                ocultarSpinner();
                mostrarNotificacion('Error al guardar cotizacion', 'error');
            }
        }

        function exportarCotizacionHTML() {
            // Recopilar datos de todas las variantes
            const variantes = [];
            
            for (let i = 1; i <= 4; i++) {
                const clientName = document.getElementById(`clientName${i}`).value;
                if (clientName) {
                    variantes.push({
                        numero: i,
                        clienteNombre: clientName,
                        clienteTelefono: document.getElementById(`clientPhone${i}`).value,
                        clienteEmail: document.getElementById(`clientEmail${i}`).value,
                        tipoVariante: document.getElementById(`variantType${i}`).value,
                        precioVenta: parseFloat(document.getElementById(`salePrice${i}`).value),
                        tiempoEntrega: document.getElementById(`deliveryTime${i}`).value,
                        garantia: document.getElementById(`warranty${i}`).value,
                        notas: document.getElementById(`notes${i}`).value
                    });
                }
            }

            if (variantes.length === 0) {
                mostrarNotificacion('‚ö†Ô∏è Completa al menos una variante', 'warning');
                return;
            }

            const folio = generarFolio();
            const fecha = new Date().toLocaleDateString('es-MX');

            let html = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizaci√≥n ${folio}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 40px 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            border-bottom: 4px solid #2563eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2563eb;
            font-size: 32px;
            margin-bottom: 10px;
        }
        .folio {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
        }
        .section {
            margin: 30px 0;
        }
        .section-title {
            background: #f0f9ff;
            padding: 12px 20px;
            border-left: 5px solid #2563eb;
            font-size: 18px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 15px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }
        .info-label {
            font-weight: bold;
            color: #475569;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .info-value {
            color: #1e293b;
            font-size: 16px;
        }
        .price-highlight {
            font-size: 32px;
            color: #10b981;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 10px;
            margin: 20px 0;
        }
        .referencias {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .ref-item {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }
        .variante-card {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }
        .variante-header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin: -25px -25px 20px -25px;
            font-size: 18px;
            font-weight: bold;
        }
        .comunicacion-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 3px solid #2563eb;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        .comunicacion-section h3 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 22px;
        }
        .botones-accion {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .formulario-respuesta {
            background: white;
            padding: 25px;
            border-radius: 8px;
            border: 2px solid #2563eb;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #1e40af;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        #qrcode {
            margin: 20px auto;
            text-align: center;
        }
        @media print {
            .comunicacion-section,
            .botones-accion,
            .formulario-respuesta {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Hospital del M√≥vil</h1>
            <p style="color: #64748b; font-size: 18px;">Cotizaci√≥n Profesional</p>
            <div class="folio">FOLIO: ${folio}</div>
            <p style="margin-top: 10px; color: #64748b;">Fecha: ${fecha}</p>
        </div>

        <div class="section">
            <div class="section-title">üì± Informaci√≥n del Dispositivo</div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Tipo</div>
                    <div class="info-value">${document.getElementById('deviceType').value.toUpperCase()}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Marca</div>
                    <div class="info-value">${document.getElementById('brand').value.toUpperCase()}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Modelo</div>
                    <div class="info-value">${document.getElementById('model').value}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Pieza</div>
                    <div class="info-value">${document.getElementById('partType').value.toUpperCase()}</div>
                </div>
            </div>
        </div>
`;

            // Agregar cada variante
            variantes.forEach((variante, index) => {
                const tipoVarianteNombre = {
                    'premium': 'üåü Premium - Original OEM',
                    'high': '‚≠ê Alta Calidad - Compatible AAA',
                    'standard': '‚úÖ Est√°ndar - Compatible A',
                    'economic': 'üí∞ Econ√≥mica - Compatible B'
                };

                html += `
        <div class="variante-card">
            <div class="variante-header">
                Opci√≥n ${variante.numero}: ${tipoVarianteNombre[variante.tipoVariante]}
            </div>

            <div class="section">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Cliente</div>
                        <div class="info-value">${variante.clienteNombre}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tel√©fono</div>
                        <div class="info-value">${variante.clienteTelefono}</div>
                    </div>
                    ${variante.clienteEmail ? `
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">${variante.clienteEmail}</div>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">Tiempo de Entrega</div>
                        <div class="info-value">${variante.tiempoEntrega}</div>
                    </div>
                </div>
            </div>

            <div class="price-highlight">
                PRECIO: $${variante.precioVenta.toFixed(2)} MXN
            </div>

            ${variante.garantia ? `
            <div class="info-item" style="margin: 20px 0;">
                <div class="info-label">Garant√≠a</div>
                <div class="info-value">${variante.garantia}</div>
            </div>
            ` : ''}

            ${variante.notas ? `
            <div class="info-item" style="margin: 20px 0;">
                <div class="info-label">Notas Adicionales</div>
                <div class="info-value">${variante.notas}</div>
            </div>
            ` : ''}
        </div>
`;
            });

            // Referencias base
            if (resultadosSeleccionados.length > 0) {
                html += `
        <div class="section">
            <div class="section-title">üìä Referencias de Precios Consultadas</div>
            <div class="referencias">
`;
                resultadosSeleccionados.forEach((ref, index) => {
                    html += `
                <div class="ref-item">
                    <strong>Referencia ${index + 1}:</strong> ${ref.producto}<br>
                    <small style="color: #64748b;">
                        ${ref.plataforma.toUpperCase()} - ${ref.condicion === 'new' ? 'Nuevo' : 'Usado'} - $${ref.precio.toFixed(2)} - ‚≠ê ${ref.valoracion}
                    </small>
                </div>
`;
                });
                html += `
            </div>
        </div>
`;
            }

            // Secci√≥n de comunicaci√≥n bidireccional
            const urlActual = window.location.href.split('?')[0];
            const whatsappNumber = CONTACTO.whatsapp;
            const whatsappMessage = `Hola, vi la cotizacion ${folio} y me interesa`;
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;
            const emailSubject = `Respuesta a Cotizacion ${folio}`;
            const emailBody = `Estimado ${CONTACTO.negocio},\n\nMe pongo en contacto respecto a la cotizacion ${folio}.\n\n`;
            const emailUrl = `mailto:${CONTACTO.email}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;

            html += `
        <div class="comunicacion-section">
            <h3>üí¨ ¬øTienes preguntas o quieres aceptar esta cotizaci√≥n?</h3>
            <p style="color: #1e40af; margin-bottom: 20px; font-size: 16px;">
                Comun√≠cate con nosotros de inmediato:
            </p>

            <div class="botones-accion">
                <a href="${whatsappUrl}" target="_blank" class="btn btn-success">
                    üì± WhatsApp
                </a>
                <a href="${emailUrl}" class="btn btn-primary">
                    ‚úâÔ∏è Email
                </a>
                <a href="tel:${whatsappNumber}" class="btn btn-primary">
                    üìû Llamar
                </a>
            </div>

            <div id="qrcode"></div>
            <p style="margin-top: 15px; color: #64748b;">
                Escanea el c√≥digo QR para contactarnos por WhatsApp
            </p>

            <div class="formulario-respuesta">
                <h4 style="color: #1e40af; margin-bottom: 15px;">üìù O d√©janos tu mensaje aqu√≠:</h4>
                <form id="responseForm">
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="respNombre" required value="${variantes[0].clienteNombre}">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="respTelefono" required value="${variantes[0].clienteTelefono}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="respEmail" value="${variantes[0].clienteEmail || ''}">
                    </div>
                    <div class="form-group">
                        <label>Decisi√≥n *</label>
                        <select id="respDecision" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <option value="">Seleccionar...</option>
                            <option value="acepto">‚úÖ Acepto la cotizaci√≥n</option>
                            <option value="duda">‚ùì Tengo dudas</option>
                            <option value="rechazo">‚ùå No me interesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mensaje *</label>
                        <textarea id="respMensaje" required placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        üì§ Enviar Respuesta
                    </button>
                </form>
            </div>
        </div>

        <div class="footer">
            <h3 style="color: #2563eb; margin-bottom: 10px;">${CONTACTO.negocio}</h3>
            <p>${CONTACTO.eslogan}</p>
            <p>WhatsApp: ${whatsappNumber} | Email: ${CONTACTO.email}</p>
            <p style="margin-top: 15px; font-size: 12px;">
                Esta cotizaci√≥n tiene una validez de 7 d√≠as a partir de la fecha de emisi√≥n.<br>
                Los precios est√°n sujetos a disponibilidad y pueden variar sin previo aviso.
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"><\/script>
    <script>
        // Generar c√≥digo QR
        QRCode.toCanvas(
            document.createElement('canvas'),
            '${whatsappUrl}',
            { width: 200, margin: 2 },
            function(error, canvas) {
                if (!error) {
                    document.getElementById('qrcode').appendChild(canvas);
                }
            }
        );

        // Manejo del formulario de respuesta
        document.getElementById('responseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const respuesta = {
                folio: '${folio}',
                fecha: new Date().toISOString(),
                nombre: document.getElementById('respNombre').value,
                telefono: document.getElementById('respTelefono').value,
                email: document.getElementById('respEmail').value,
                decision: document.getElementById('respDecision').value,
                mensaje: document.getElementById('respMensaje').value
            };

            try {
                await fetch('${WEB_APP_URL}', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'saveRespuesta',
                        data: respuesta
                    })
                });

                alert('‚úÖ ¬°Tu respuesta ha sido enviada! Nos pondremos en contacto contigo pronto.');
                this.reset();

            } catch (error) {
                console.error('Error:', error);
                alert('‚ö†Ô∏è Hubo un problema al enviar tu respuesta. Por favor contacta directamente por WhatsApp o Email.');
            }
        });
    <\/script>
</body>
</html>
`;

            // Descargar HTML
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Cotizacion_${folio}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            mostrarNotificacion('‚úÖ Cotizaci√≥n HTML exportada exitosamente', 'success');
        }

        function exportarCotizacionPDF() {
            mostrarNotificacion('Usa Ctrl+P para guardar como PDF', 'warning');
            setTimeout(() => window.print(), 500);
        }

        async function exportarCotizacionJPG() {
            try {
                mostrarSpinner();

                // Generar el mismo HTML que exportarCotizacionHTML pero renderizarlo en un iframe oculto
                // y capturarlo con html2canvas
                const script = document.createElement('script');
                if (!window.html2canvas) {
                    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }

                // Crear contenedor temporal con el contenido de la cotizacion
                const folio = generarFolio();
                const variantes = [];
                for (let i = 1; i <= 4; i++) {
                    const clientName = document.getElementById(`clientName${i}`).value;
                    if (clientName) {
                        variantes.push({
                            numero: i,
                            clienteNombre: clientName,
                            clienteTelefono: document.getElementById(`clientPhone${i}`).value,
                            tipoVariante: document.getElementById(`variantType${i}`).value,
                            precioVenta: document.getElementById(`salePrice${i}`).value,
                            tiempoEntrega: document.getElementById(`deliveryTime${i}`).value,
                            garantia: document.getElementById(`warranty${i}`).value,
                            notas: document.getElementById(`notes${i}`).value
                        });
                    }
                }

                const marca = document.getElementById('brand').value || 'N/A';
                const modelo = document.getElementById('model').value || 'N/A';
                const pieza = document.getElementById('partType').value || 'N/A';
                const fecha = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });

                // Crear div temporal para renderizar
                const container = document.createElement('div');
                container.style.cssText = 'position:fixed;left:-9999px;top:0;width:800px;background:white;padding:40px;font-family:Arial,sans-serif;';

                let variantesHTML = '';
                variantes.forEach(v => {
                    variantesHTML += `
                        <div style="border:2px solid #e5e7eb;border-radius:12px;padding:20px;margin:15px 0;background:#f9fafb;">
                            <h4 style="color:#2563eb;margin:0 0 10px;">Opcion ${v.numero}: ${v.tipoVariante || 'Estandar'}</h4>
                            <p><strong>Cliente:</strong> ${v.clienteNombre}</p>
                            ${v.clienteTelefono ? `<p><strong>Tel:</strong> ${v.clienteTelefono}</p>` : ''}
                            <p style="font-size:24px;color:#059669;font-weight:bold;margin:10px 0;">$${parseFloat(v.precioVenta || 0).toLocaleString('es-MX', {minimumFractionDigits:2})}</p>
                            ${v.tiempoEntrega ? `<p><strong>Entrega:</strong> ${v.tiempoEntrega}</p>` : ''}
                            ${v.garantia ? `<p><strong>Garantia:</strong> ${v.garantia}</p>` : ''}
                            ${v.notas ? `<p><strong>Notas:</strong> ${v.notas}</p>` : ''}
                        </div>`;
                });

                let refHTML = '';
                if (resultadosSeleccionados.length > 0) {
                    refHTML = '<h3 style="color:#1e40af;margin-top:25px;">Referencias de Precio</h3><table style="width:100%;border-collapse:collapse;font-size:13px;">';
                    refHTML += '<tr style="background:#2563eb;color:white;"><th style="padding:8px;text-align:left;">Producto</th><th style="padding:8px;">Plataforma</th><th style="padding:8px;text-align:right;">Precio</th></tr>';
                    resultadosSeleccionados.forEach((r, i) => {
                        const bg = i % 2 === 0 ? '#f9fafb' : '#ffffff';
                        refHTML += `<tr style="background:${bg};"><td style="padding:8px;">${(r.titulo || r.title || '').substring(0,50)}</td><td style="padding:8px;text-align:center;">${r.plataforma || r.platform || ''}</td><td style="padding:8px;text-align:right;">$${parseFloat(r.precio || r.price || 0).toLocaleString('es-MX', {minimumFractionDigits:2})}</td></tr>`;
                    });
                    refHTML += '</table>';
                }

                container.innerHTML = `
                    <div style="text-align:center;border-bottom:3px solid #2563eb;padding-bottom:20px;margin-bottom:20px;">
                        <h1 style="color:#2563eb;margin:0;font-size:28px;">${CONTACTO.negocio}</h1>
                        <p style="color:#64748b;margin:5px 0;">${CONTACTO.eslogan}</p>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
                        <div><strong>Folio:</strong> ${folio}</div>
                        <div><strong>Fecha:</strong> ${fecha}</div>
                    </div>
                    <div style="background:#eff6ff;padding:15px;border-radius:8px;margin-bottom:20px;">
                        <h3 style="margin:0 0 10px;color:#1e40af;">Dispositivo</h3>
                        <p style="margin:3px 0;"><strong>Marca:</strong> ${marca} | <strong>Modelo:</strong> ${modelo} | <strong>Pieza:</strong> ${pieza}</p>
                    </div>
                    ${variantesHTML}
                    ${refHTML}
                    <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;color:#64748b;font-size:12px;">
                        <p><strong>${CONTACTO.negocio}</strong></p>
                        <p>WhatsApp: ${CONTACTO.whatsapp} | Email: ${CONTACTO.email}</p>
                        <p>Cotizacion valida por 7 dias. Precios sujetos a disponibilidad.</p>
                    </div>`;

                document.body.appendChild(container);

                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                document.body.removeChild(container);

                // Descargar como JPG
                const link = document.createElement('a');
                link.download = `Cotizacion_${folio}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();

                ocultarSpinner();
                mostrarNotificacion('Cotizacion JPG exportada exitosamente', 'success');

            } catch (error) {
                console.error('Error exportando JPG:', error);
                ocultarSpinner();
                mostrarNotificacion('Error al exportar JPG: ' + error.message, 'error');
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function generarFolio() {
            const fecha = new Date();
            const a√±o = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const dia = String(fecha.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `HM-${a√±o}${mes}${dia}-${random}`;
        }

        function limpiarFormulario() {
            document.getElementById('searchForm').reset();
            todosLosResultados = [];
            resultadosFiltrados = [];
            resultadosSeleccionados = [];
            dispositivosCompletos = [];
            
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('comparisonSection').style.display = 'none';

            mostrarNotificacion('üóëÔ∏è Formulario limpiado', 'success');
        }

        function mostrarSpinner() {
            const spinner = document.createElement('div');
            spinner.id = 'loadingSpinner';
            spinner.innerHTML = '<div class="spinner"></div>';
            spinner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            document.body.appendChild(spinner);
        }

        function ocultarSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.remove();
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.textContent = mensaje;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Click fuera del modal para cerrar
        window.onclick = function(event) {
            const modal = document.getElementById('quoteModal');
            if (event.target === modal) {
                cerrarModalCotizacion();
            }
        }
    </script>
</body>
</html>
